{% extends "base.html" %}

{% block title %}{% if is_create %}Opret enhed{% else %}Rediger {{ entity.name }}{% endif %} - Kentaur Onboarding{% endblock %}

{% block content %}
<div class="mt-14">
    <div class="mb-6">
        <a href="{% url 'entities:list' %}" class="text-sm text-gray-500 hover:text-gray-700 mb-1 inline-block">&larr; Tilbage til enheder</a>
        <h1 class="text-2xl font-bold text-gray-900">
            {% if is_create %}Opret enhed{% else %}Rediger {{ entity.name }}{% endif %}
        </h1>
    </div>

    <form method="post" class="space-y-6" id="entity-form">
        {% csrf_token %}

        <div class="bg-white shadow rounded-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">Grundoplysninger</h2>
            <div class="space-y-4">
                <div>
                    <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Navn</label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Beskrivelse</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.description.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label>
                    <div class="flex gap-2 items-start">
                        <div class="flex-1">
                            {{ form.category }}
                        </div>
                        <button type="button" id="add-category-btn"
                                class="bg-gray-100 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition whitespace-nowrap"
                                title="Opret ny kategori">
                            + Ny
                        </button>
                    </div>
                    <div id="new-category-form" class="hidden mt-2 flex gap-2 items-center">
                        <input type="text" id="new-category-name"
                               class="flex-1 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm"
                               placeholder="Ny kategori-navn..." maxlength="200">
                        <button type="button" id="save-category-btn"
                                class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-xs font-medium hover:bg-indigo-700 transition">
                            Opret
                        </button>
                        <button type="button" id="cancel-category-btn"
                                class="text-gray-500 hover:text-gray-700 text-xs font-medium">
                            Annuller
                        </button>
                    </div>
                    {% if form.category.errors %}
                    <p class="text-red-600 text-sm mt-1">{{ form.category.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="bg-white shadow rounded-lg p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">Brugerdefinerede felter</h2>
                <button type="button" id="add-field-btn"
                        class="bg-indigo-600 text-white px-3 py-1.5 rounded-lg text-sm font-medium hover:bg-indigo-700 transition flex items-center gap-1">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    Tilføj felt
                </button>
            </div>
            {{ formset.management_form }}
            <div id="custom-fields-container">
                <table class="min-w-full" id="fields-table">
                    <thead id="fields-thead">
                        <tr class="text-left text-xs font-medium text-gray-500 uppercase">
                            <th class="pb-2 pr-2 w-1/4">Feltnavn</th>
                            <th class="pb-2 pr-2 w-32">Type</th>
                            <th class="pb-2 pr-2 w-20 text-center">Påkrævet</th>
                            <th class="pb-2 pr-2 w-20 text-center">Overblik</th>
                            <th class="pb-2 pr-2 w-1/4">Standardværdi</th>
                            <th class="pb-2 pr-2 w-20">Sortering</th>
                            <th class="pb-2 w-20 text-center">Fjern</th>
                        </tr>
                    </thead>
                    <tbody id="fields-body">
                        {% for field_form in formset %}
                        <tr class="field-row" data-form-index="{{ forloop.counter0 }}">
                            <td class="pr-2 py-1">
                                {{ field_form.id }}
                                {{ field_form.name }}
                                {% if field_form.name.errors %}<p class="text-red-600 text-xs mt-1">{{ field_form.name.errors.0 }}</p>{% endif %}
                            </td>
                            <td class="pr-2 py-1">{{ field_form.field_type }}</td>
                            <td class="pr-2 py-1 text-center">{{ field_form.is_required }}</td>
                            <td class="pr-2 py-1 text-center">{{ field_form.show_on_overview }}</td>
                            <td class="pr-2 py-1">{{ field_form.default_value }}</td>
                            <td class="pr-2 py-1">{{ field_form.sort_order }}</td>
                            <td class="py-1 text-center">
                                {% if field_form.instance.pk %}
                                <div class="hidden">{{ field_form.DELETE }}</div>
                                <button type="button" class="delete-field-btn text-red-500 hover:text-red-700 p-1" title="Fjern felt">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                                {% else %}
                                <button type="button" class="remove-new-field-btn text-red-500 hover:text-red-700 p-1" title="Fjern felt">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                <div id="no-fields-message" class="text-center py-4 text-gray-400 text-sm hidden">
                    Ingen felter endnu. Klik "Tilføj felt" for at tilføje et brugerdefineret felt.
                </div>
            </div>
            {% if formset.non_form_errors %}
            <div class="text-red-600 text-sm mt-2">{{ formset.non_form_errors }}</div>
            {% endif %}
        </div>

        <div class="flex justify-end gap-3">
            <a href="{% if is_create %}{% url 'entities:list' %}{% else %}{% url 'entities:detail' entity.pk %}{% endif %}"
               class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg text-sm font-medium hover:bg-gray-200 transition">
                Annuller
            </a>
            <button type="submit"
                    class="bg-indigo-600 text-white px-6 py-2 rounded-lg text-sm font-medium hover:bg-indigo-700 transition">
                {% if is_create %}Opret enhed{% else %}Gem ændringer{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function() {
    const tbody = document.getElementById('fields-body');
    const thead = document.getElementById('fields-thead');
    const addBtn = document.getElementById('add-field-btn');
    const totalFormsInput = document.getElementById('id_custom_fields-TOTAL_FORMS');
    const noFieldsMsg = document.getElementById('no-fields-message');

    const inputClasses = 'w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm';
    const selectClasses = 'rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm';
    const checkboxClasses = 'rounded border-gray-300 text-indigo-600 focus:ring-indigo-500';
    const smallInputClasses = 'w-20 rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm';

    function updateVisibility() {
        const visibleRows = tbody.querySelectorAll('tr.field-row:not(.deleted)');
        if (visibleRows.length === 0) {
            noFieldsMsg.classList.remove('hidden');
            thead.classList.add('hidden');
        } else {
            noFieldsMsg.classList.add('hidden');
            thead.classList.remove('hidden');
        }
    }

    // Renumber all form inputs so Django formset indices are consecutive (0,1,2...)
    function renumberForms() {
        var rows = tbody.querySelectorAll('tr.field-row');
        var total = rows.length;
        rows.forEach(function(row, idx) {
            row.dataset.formIndex = idx;
            // Update all input/select/textarea names and ids within this row
            var elements = row.querySelectorAll('input, select, textarea');
            elements.forEach(function(el) {
                if (el.name) {
                    el.name = el.name.replace(/custom_fields-\d+/, 'custom_fields-' + idx);
                }
                if (el.id) {
                    el.id = el.id.replace(/custom_fields-\d+/, 'custom_fields-' + idx);
                }
            });
        });
        totalFormsInput.value = total;
    }

    // --- Todo-list default value editor ---
    function escapeHtml(text) {
        var div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function buildTodoEditor(cell, hiddenInput) {
        // Parse existing value: newline-separated items
        var items = (hiddenInput.value || '').split('\n').filter(function(s) { return s.trim(); });

        var wrapper = document.createElement('div');
        wrapper.className = 'todo-default-editor';

        function render() {
            var html = '<div class="space-y-1 todo-default-items">';
            items.forEach(function(item, idx) {
                html += '<div class="flex items-center gap-1">' +
                    '<span class="text-xs text-gray-500 flex-1">' + escapeHtml(item) + '</span>' +
                    '<button type="button" class="todo-def-remove text-red-400 hover:text-red-600 text-xs" data-idx="' + idx + '">&times;</button>' +
                    '</div>';
            });
            html += '</div>';
            html += '<div class="flex gap-1 mt-1">' +
                '<input type="text" class="todo-def-input flex-1 rounded border-gray-300 text-xs py-0.5 px-1 focus:border-indigo-500 focus:ring-indigo-500" placeholder="Tilf\u00f8j punkt...">' +
                '<button type="button" class="todo-def-add bg-indigo-600 text-white text-xs px-2 py-0.5 rounded hover:bg-indigo-700">+</button>' +
                '</div>';
            wrapper.innerHTML = html;

            // Sync hidden input
            hiddenInput.value = items.join('\n');
        }

        wrapper.addEventListener('click', function(e) {
            var removeBtn = e.target.closest('.todo-def-remove');
            if (removeBtn) {
                items.splice(parseInt(removeBtn.dataset.idx), 1);
                render();
                return;
            }
            var addBtn = e.target.closest('.todo-def-add');
            if (addBtn) {
                var input = wrapper.querySelector('.todo-def-input');
                var text = input.value.trim();
                if (text) {
                    items.push(text);
                    render();
                    wrapper.querySelector('.todo-def-input').focus();
                }
            }
        });

        wrapper.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && e.target.classList.contains('todo-def-input')) {
                e.preventDefault();
                var text = e.target.value.trim();
                if (text) {
                    items.push(text);
                    render();
                    wrapper.querySelector('.todo-def-input').focus();
                }
            }
        });

        render();
        return wrapper;
    }

    function updateDefaultValueCell(row) {
        var typeSelect = row.querySelector('select[name$="-field_type"]');
        if (!typeSelect) return;

        var defaultCell = row.querySelector('td:nth-child(5)');
        if (!defaultCell) return;

        var hiddenInput = defaultCell.querySelector('input[name$="-default_value"]');
        var existingEditor = defaultCell.querySelector('.todo-default-editor');

        if (typeSelect.value === 'todolist') {
            // Show todo editor, hide the text input
            if (!existingEditor) {
                if (!hiddenInput) {
                    // Create the hidden input (for new rows)
                    var prefix = 'custom_fields-' + row.dataset.formIndex;
                    hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = prefix + '-default_value';
                    hiddenInput.id = 'id_' + prefix + '-default_value';
                    hiddenInput.value = '';
                    defaultCell.appendChild(hiddenInput);
                }
                hiddenInput.type = 'hidden';
                var editor = buildTodoEditor(defaultCell, hiddenInput);
                defaultCell.appendChild(editor);
            }
        } else {
            // Remove todo editor, show text input
            if (existingEditor) {
                existingEditor.remove();
            }
            if (hiddenInput) {
                hiddenInput.type = 'text';
                hiddenInput.className = inputClasses;
                hiddenInput.placeholder = 'Standardv\u00e6rdi';
                hiddenInput.maxLength = 500;
            }
        }
    }

    // Listen for field_type changes
    tbody.addEventListener('change', function(e) {
        if (e.target.name && e.target.name.endsWith('-field_type')) {
            var row = e.target.closest('tr.field-row');
            if (row) updateDefaultValueCell(row);
        }
    });

    // Initialize existing todolist rows on page load
    tbody.querySelectorAll('tr.field-row').forEach(function(row) {
        updateDefaultValueCell(row);
    });

    // Add new field row
    addBtn.addEventListener('click', function() {
        const idx = parseInt(totalFormsInput.value);
        const prefix = 'custom_fields-' + idx;

        const tr = document.createElement('tr');
        tr.className = 'field-row';
        tr.dataset.formIndex = idx;
        tr.innerHTML =
            '<td class="pr-2 py-1">' +
                '<input type="text" name="' + prefix + '-name" id="id_' + prefix + '-name" ' +
                'class="' + inputClasses + '" placeholder="Feltnavn" maxlength="200">' +
            '</td>' +
            '<td class="pr-2 py-1">' +
                '<select name="' + prefix + '-field_type" id="id_' + prefix + '-field_type" class="' + selectClasses + '">' +
                    '<option value="text">Tekst</option>' +
                    '<option value="number">Tal</option>' +
                    '<option value="checkbox">Checkbox</option>' +
                    '<option value="todolist">Todo-liste</option>' +
                '</select>' +
            '</td>' +
            '<td class="pr-2 py-1 text-center">' +
                '<input type="checkbox" name="' + prefix + '-is_required" id="id_' + prefix + '-is_required" ' +
                'class="' + checkboxClasses + '">' +
            '</td>' +
            '<td class="pr-2 py-1 text-center">' +
                '<input type="checkbox" name="' + prefix + '-show_on_overview" id="id_' + prefix + '-show_on_overview" ' +
                'class="' + checkboxClasses + '">' +
            '</td>' +
            '<td class="pr-2 py-1">' +
                '<input type="text" name="' + prefix + '-default_value" id="id_' + prefix + '-default_value" ' +
                'class="' + inputClasses + '" placeholder="Standardv\u00e6rdi" maxlength="500">' +
            '</td>' +
            '<td class="pr-2 py-1">' +
                '<input type="number" name="' + prefix + '-sort_order" id="id_' + prefix + '-sort_order" ' +
                'class="' + smallInputClasses + '" value="' + (idx * 10) + '" min="0">' +
            '</td>' +
            '<td class="py-1 text-center">' +
                '<button type="button" class="remove-new-field-btn text-red-500 hover:text-red-700 p-1" title="Fjern felt">' +
                    '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                        '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>' +
                    '</svg>' +
                '</button>' +
            '</td>';

        tbody.appendChild(tr);
        totalFormsInput.value = idx + 1;
        updateVisibility();
        tr.querySelector('input[name$="-name"]').focus();
    });

    // Delegated click handler for delete/undo/remove buttons
    tbody.addEventListener('click', function(e) {
        // Mark existing field for deletion
        var deleteBtn = e.target.closest('.delete-field-btn');
        if (deleteBtn) {
            var row = deleteBtn.closest('tr');
            var checkbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (checkbox) {
                checkbox.checked = true;
                row.classList.add('deleted');
                row.style.opacity = '0.3';
                deleteBtn.outerHTML =
                    '<button type="button" class="undo-delete-btn text-indigo-600 hover:text-indigo-800 p-1 text-xs font-medium" title="Fortryd">' +
                        'Fortryd' +
                    '</button>';
            }
            updateVisibility();
            return;
        }

        // Undo delete
        var undoBtn = e.target.closest('.undo-delete-btn');
        if (undoBtn) {
            var row = undoBtn.closest('tr');
            var checkbox = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
            if (checkbox) {
                checkbox.checked = false;
                row.classList.remove('deleted');
                row.style.opacity = '';
                undoBtn.outerHTML =
                    '<button type="button" class="delete-field-btn text-red-500 hover:text-red-700 p-1" title="Fjern felt">' +
                        '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
                            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>' +
                        '</svg>' +
                    '</button>';
            }
            updateVisibility();
            return;
        }

        // Remove unsaved new field entirely
        var removeBtn = e.target.closest('.remove-new-field-btn');
        if (removeBtn) {
            removeBtn.closest('tr').remove();
            renumberForms();
            updateVisibility();
        }
    });

    updateVisibility();

    // --- Inline category creation ---
    var addCatBtn = document.getElementById('add-category-btn');
    var newCatForm = document.getElementById('new-category-form');
    var newCatInput = document.getElementById('new-category-name');
    var saveCatBtn = document.getElementById('save-category-btn');
    var cancelCatBtn = document.getElementById('cancel-category-btn');
    var catSelect = document.getElementById('id_category');

    if (addCatBtn && newCatForm) {
        addCatBtn.addEventListener('click', function() {
            newCatForm.classList.remove('hidden');
            addCatBtn.classList.add('hidden');
            newCatInput.value = '';
            newCatInput.focus();
        });

        cancelCatBtn.addEventListener('click', function() {
            newCatForm.classList.add('hidden');
            addCatBtn.classList.remove('hidden');
        });

        function saveNewCategory() {
            var name = newCatInput.value.trim();
            if (!name) return;

            var csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
            fetch('{% url "entities:category_create_ajax" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({name: name}),
            })
            .then(function(resp) { return resp.json(); })
            .then(function(data) {
                if (data.error) {
                    alert(data.error);
                    return;
                }
                // Add option to select and choose it
                var option = document.createElement('option');
                option.value = data.id;
                option.textContent = data.name;
                catSelect.appendChild(option);
                catSelect.value = data.id;

                // Close inline form
                newCatForm.classList.add('hidden');
                addCatBtn.classList.remove('hidden');
            });
        }

        saveCatBtn.addEventListener('click', saveNewCategory);
        newCatInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveNewCategory();
            }
        });
    }
})();
</script>
{% endblock %}
